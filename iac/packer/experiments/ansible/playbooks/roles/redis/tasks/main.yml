- name: Install build dependencies for Redis
  ansible.builtin.package:
    name:
      - build-essential
      - tcl
    state: present
  become: true

- name: Download Redis source code
  ansible.builtin.get_url:
    url: "http://download.redis.io/releases/redis-7.2.4.tar.gz"
    dest: "/tmp/redis-7.2.4.tar.gz"
    mode: '0644'
  become: true

- name: Extract Redis source code
  ansible.builtin.unarchive:
    src: "/tmp/redis-7.2.4.tar.gz"
    dest: "/tmp"
    remote_src: yes
  become: true

- name: Compile Redis
  ansible.builtin.shell:
    cmd: make
    chdir: /tmp/redis-7.2.4
  become: true

- name: Install Redis
  ansible.builtin.shell:
    cmd: make install
    chdir: /tmp/redis-7.2.4
  become: true

- name: Update Redis configuration file
  ansible.builtin.lineinfile:
    path: "{{ redis_configuration_file }}"
    regexp: "^{{ item.option }}"
    line: "{{ item.option }} {{ item.value }}"
    state: present
  loop:
    - { option: "bind", value: "{{ redis_bind_interface }}" }
    - { option: "maxmemory-policy", value: "{{ redis_maxmemory_policy }}" }
  notify: restart redis

- name: Ensure Redis is running and enabled
  ansible.builtin.service:
    name: "{{ redis_service_name }}"
    state: started
    enabled: yes

- name: Disable specific Redis commands
  ansible.builtin.lineinfile:
    path: "{{ redis_configuration_file }}"
    regexp: '^rename-command {{ item }} '
    line: "rename-command {{ item }} \"\""
    state: present
  loop: "{{ redis_disabled_commands }}"

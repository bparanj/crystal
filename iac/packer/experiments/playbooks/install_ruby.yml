---
- name: Install Ruby 3.3.0 from source
  hosts: all
  become: true
  vars:
    ruby_version: "3.3.0"
    ruby_download_url: "https://cache.ruby-lang.org/pub/ruby/3.3/ruby-{{ ruby_version }}.tar.gz"
    ruby_source_dir: "/usr/local/src/ruby-{{ ruby_version }}"
    ruby_prefix_dir: "/usr/local"

  tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name:
          - build-essential
          - libssl-dev
          - libreadline-dev
          - zlib1g-dev
        state: present
        update_cache: yes

    - name: Download Ruby source code
      ansible.builtin.get_url:
        url: "{{ ruby_download_url }}"
        dest: "/tmp/ruby-{{ ruby_version }}.tar.gz"
        mode: '0644'

    - name: Extract Ruby source code
      ansible.builtin.unarchive:
        src: "/tmp/ruby-{{ ruby_version }}.tar.gz"
        dest: "/usr/local/src"
        remote_src: yes
        creates: "{{ ruby_source_dir }}"

    - name: Configure Ruby source
      ansible.builtin.shell:
        cmd: "./configure --prefix={{ ruby_prefix_dir }} --disable-install-doc"
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_source_dir }}/Makefile"

    - name: Compile Ruby source
      ansible.builtin.shell:
        cmd: "make -j$(nproc)"
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_source_dir }}/ruby"

    - name: Install Ruby
      ansible.builtin.shell:
        cmd: "make install"
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_prefix_dir }}/bin/ruby"

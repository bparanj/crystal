Here's a Ansible playbook for installing and configuring Fail2ban on Ubuntu 22.04:

**Filename: fail2ban-playbook.yml**

```yaml
---
- name: Install and configure Fail2ban
  hosts: all  # Replace 'all' with your specific host group
  become: true  # Required for package installation and service management

  tasks:
    - name: Install Fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Copy default Fail2ban configuration (for backup)
      copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.conf.backup
        remote_src: yes  

    - name: Create Fail2ban local configuration
      template:
        src: jail.local.j2  # You'll need to create this template
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: 0644

    - name: Ensure Fail2ban service is enabled and running
      service:
        name: fail2ban
        state: started
        enabled: true
```

**Important Parts**

* **Hosts:** Update the `hosts` line to target the servers where you want Fail2ban.
* **`jail.local.j2`** (Template): You need to create a Jinja2 template file named `jail.local.j2`. This will contain your custom Fail2ban jail configurations. See a basic example below.

**Example `jail.local.j2` template**

```jinja2
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1  # Add your trusted IPs
bantime = 86400  # Ban for 1 day 
findtime = 600   # Find suspicious attempts within 10 minutes
maxretry = 3     # Allow 3 retries before banning

[sshd]
enabled = true
```

**How to Use**

1.  **Create the `jail.local.j2` file:** Populate it with your desired Fail2ban jail configurations. Place it in a `templates` folder next to your playbook.
2.  **Run the playbook:** `ansible-playbook fail2ban-playbook.yml`

**Key Points**

* **Customization:** The key to this playbook is the `jail.local.j2` template. Edit it extensively to define the jails and protection rules you want.
* **Roles:** For larger setups, consider using a dedicated Ansible role (e.g., from Ansible Galaxy) for more organized management of Fail2ban configuration. 

**Let me know if you'd like help crafting a more elaborate `jail.local.j2` template with specific filters and actions** 

Here's an Ansible playbook that installs and configures Fail2Ban on an Ubuntu 22.04 server. This playbook includes tasks to:

1. **Install Fail2Ban**: Ensures that Fail2Ban is installed.
2. **Configure Fail2Ban**: Copies a custom configuration file from the control node to the target node. You'll need to create this configuration file based on your specific needs.
3. **Ensure Fail2Ban is running and enabled on boot**: Manages the state of the Fail2Ban service.

```yaml
---
- name: Install and configure Fail2Ban on Ubuntu 22.04
  hosts: your_host_group
  become: yes  # Required to gain root privileges
  tasks:
    - name: Install Fail2Ban
      ansible.builtin.apt:
        name: fail2ban
        state: present

    - name: Copy Fail2Ban configuration file
      ansible.builtin.copy:
        src: /path/to/your/jail.local
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: restart fail2ban

    - name: Ensure Fail2Ban is running and enabled on boot
      ansible.builtin.service:
        name: fail2ban
        state: started
        enabled: yes

  handlers:
    - name: restart fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted
```

Before running this playbook:

- Replace `your_host_group` with the group name of your target servers defined in your Ansible inventory. If you're targeting a single server, specify its hostname or IP address.
- Ensure you have a Fail2Ban configuration file ready to be deployed (`jail.local`). The path `/path/to/your/jail.local` should be replaced with the actual path to your customized `jail.local` file on the control node. The `jail.local` file is used to override the default configuration settings.
- Ensure Ansible is installed on your control machine and you have SSH access to the target machine(s).

To run the playbook, save it to a file (e.g., `install_fail2ban.yml`), and then use the `ansible-playbook` command:

```sh
ansible-playbook install_fail2ban.yml
```

This playbook is a basic example. You might want to further customize the Fail2Ban configuration to meet your specific needs. You can do this by modifying the `jail.local` file or by adding more tasks to the playbook to deploy additional configuration files as necessary.

Here's a Ansible playbook for installing and configuring Fail2ban on Ubuntu 22.04:

**Filename: fail2ban-playbook.yml**

```yaml
---
- name: Install and configure Fail2ban
  hosts: all  # Replace 'all' with your specific host group
  become: true  # Required for package installation and service management

  tasks:
    - name: Install Fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Copy default Fail2ban configuration (for backup)
      copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.conf.backup
        remote_src: yes  

    - name: Create Fail2ban local configuration
      template:
        src: jail.local.j2  # You'll need to create this template
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: 0644

    - name: Ensure Fail2ban service is enabled and running
      service:
        name: fail2ban
        state: started
        enabled: true
```

**Important Parts**

* **Hosts:** Update the `hosts` line to target the servers where you want Fail2ban.
* **`jail.local.j2`** (Template): You need to create a Jinja2 template file named `jail.local.j2`. This will contain your custom Fail2ban jail configurations. See a basic example below.

**Example `jail.local.j2` template**

```jinja2
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1  # Add your trusted IPs
bantime = 86400  # Ban for 1 day 
findtime = 600   # Find suspicious attempts within 10 minutes
maxretry = 3     # Allow 3 retries before banning

[sshd]
enabled = true
```

**How to Use**

1.  **Create the `jail.local.j2` file:** Populate it with your desired Fail2ban jail configurations. Place it in a `templates` folder next to your playbook.
2.  **Run the playbook:** `ansible-playbook fail2ban-playbook.yml`

**Key Points**

* **Customization:** The key to this playbook is the `jail.local.j2` template. Edit it extensively to define the jails and protection rules you want.
* **Roles:** For larger setups, consider using a dedicated Ansible role (e.g., from Ansible Galaxy) for more organized management of Fail2ban configuration. 

**Let me know if you'd like help crafting a more elaborate `jail.local.j2` template with specific filters and actions** 

Here's an Ansible playbook that installs and configures Fail2Ban on an Ubuntu 22.04 server. This playbook includes tasks to:

1. **Install Fail2Ban**: Ensures that Fail2Ban is installed.
2. **Configure Fail2Ban**: Copies a custom configuration file from the control node to the target node. You'll need to create this configuration file based on your specific needs.
3. **Ensure Fail2Ban is running and enabled on boot**: Manages the state of the Fail2Ban service.

```yaml
---
- name: Install and configure Fail2Ban on Ubuntu 22.04
  hosts: your_host_group
  become: yes  # Required to gain root privileges
  tasks:
    - name: Install Fail2Ban
      ansible.builtin.apt:
        name: fail2ban
        state: present

    - name: Copy Fail2Ban configuration file
      ansible.builtin.copy:
        src: /path/to/your/jail.local
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: restart fail2ban

    - name: Ensure Fail2Ban is running and enabled on boot
      ansible.builtin.service:
        name: fail2ban
        state: started
        enabled: yes

  handlers:
    - name: restart fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted
```

Before running this playbook:

- Replace `your_host_group` with the group name of your target servers defined in your Ansible inventory. If you're targeting a single server, specify its hostname or IP address.
- Ensure you have a Fail2Ban configuration file ready to be deployed (`jail.local`). The path `/path/to/your/jail.local` should be replaced with the actual path to your customized `jail.local` file on the control node. The `jail.local` file is used to override the default configuration settings.
- Ensure Ansible is installed on your control machine and you have SSH access to the target machine(s).

To run the playbook, save it to a file (e.g., `install_fail2ban.yml`), and then use the `ansible-playbook` command:

```sh
ansible-playbook install_fail2ban.yml
```

This playbook is a basic example. You might want to further customize the Fail2Ban configuration to meet your specific needs. You can do this by modifying the `jail.local` file or by adding more tasks to the playbook to deploy additional configuration files as necessary.

Creating a basic configuration file for Fail2Ban involves setting up a few key elements. Fail2Ban works by monitoring log files for patterns that indicate malicious activity, such as repeated failed login attempts, and then applying rules to block the offending IP addresses, usually through firewall rules.

Fail2Ban configurations can be overridden or extended by creating or modifying the `jail.local` file in the `/etc/fail2ban` directory. This file does not exist by default, but when created, it allows you to customize settings without modifying the default `jail.conf` file, ensuring your custom settings are preserved across package updates.

Here's a basic `jail.local` configuration that you can use as a starting point. This example includes a jail for SSH (which is very common), but you can extend it with more services as needed.

```ini
[DEFAULT]
# Ban hosts for one hour:
bantime = 1h

# Find 5 failures within a 10-minute window:
findtime = 10m

# The number of failures before a host gets banned.
maxretry = 5

# Email configuration for notifications.
destemail = your_email@example.com
sender = fail2ban@example.com
mta = sendmail
action = %(action_mwl)s

# Override the default ignoreip value if you have IPs that should never be banned.
# ignoreip = 127.0.0.1/8 ::1

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
```

### Key Elements of the Configuration

- **[DEFAULT]**: Settings in this section apply to all jails unless overridden in the jail's specific section.
- **bantime**: The duration for which an IP is banned. This can be specified in seconds or using a time duration (e.g., `1h` for one hour, `1d` for one day).
- **findtime** and **maxretry**: These settings define the failure threshold for banning. If Fail2Ban finds `maxretry` failed attempts within a `findtime` period, the source IP will be banned.
- **destemail** and **action**: Configuration for email notifications. The `action = %(action_mwl)s` line configures Fail2Ban to send an email with whois information and relevant log lines on ban. Make sure to replace `your_email@example.com` with your actual email address.
- **[sshd]**: A jail for monitoring SSH login attempts. This section can be customized or extended with additional jails for other services.

### Extending Your Configuration

To monitor other services, you can add more sections similar to `[sshd]`. For each service, you would specify the service-specific settings such as `enabled`, `filter`, `port`, `logpath`, and any custom values for `findtime`, `bantime`, and `maxretry`.

Before implementing this configuration, ensure you have Fail2Ban installed and that you create or modify the `jail.local` file with appropriate permissions. Also, test your configuration to ensure it behaves as expected, paying special attention to the impact of banning policies on legitimate users and services.

Yes, adding the line `ignoreip = 127.0.0.1/8 ::1` to your Fail2Ban configuration file is a good starting point. This setting instructs Fail2Ban to ignore any ban actions for the specified IP addresses. `127.0.0.1/8` represents the loopback address range (localhost) for IPv4, and `::1` is the loopback address for IPv6. By including this line, you prevent Fail2Ban from banning legitimate access from the local system, which is especially important for services that might have legitimate reasons to connect frequently and could otherwise be mistakenly banned.

Here's a basic example of a Fail2Ban configuration file (`jail.local`) that you can use as a starting point. This file overrides some default settings from `jail.conf` and specifies a few common jails:

```ini
[DEFAULT]
# "ignoreip" can be an IP address, a CIDR mask, or a DNS host. Here, localhost is excluded.
ignoreip = 127.0.0.1/8 ::1

# "bantime" is the duration of time a host is banned.
bantime = 10m

# "findtime" is the duration of time that a host is monitored for repeated failures.
findtime = 10m

# "maxretry" is the number of failures that triggers a ban action against the host.
maxretry = 5

# Email for sending ban notifications.
destemail = your_email@example.com

# Action to take when banning an IP. See action.d/ directory for other options.
action = %(action_mwl)s

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3

[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 6

```

This configuration:

- Ignores localhost for banning actions.
- Sets a default ban time of 10 minutes.
- Observes failed attempts within a 10-minute window.
- Triggers a ban after 5 retries by default, but adjusts this for specific services (e.g., 3 retries for SSH).
- Uses the `action_mwl` action, which bans the IP and sends an email with the whois report and relevant log lines.

Remember to replace `your_email@example.com` with your actual email address if you wish to receive notifications. Also, ensure that you have mail utilities configured on your server for email notifications to work.

Before deploying this configuration, review and adjust the settings to match your security policies and operational requirements. Fail2Ban is highly customizable, allowing you to fine-tune its behavior to best fit your environment.

Ubuntu 22.04 (Jammy Jellyfish) does not come with `sendmail` installed by default. Ubuntu typically includes minimal packages necessary for a basic setup to keep the installation lean. For mail services, users are encouraged to install the mail server software that best fits their needs, whether it be `sendmail`, `Postfix`, `Exim`, or any other MTA (Mail Transfer Agent).

If you need `sendmail` or a similar MTA for sending emails from your server, you can easily install it. For example, to install `Postfix`, which is commonly used as an alternative to `sendmail` and often preferred for its simpler configuration, you can use the following command:

```sh
sudo apt update
sudo apt install postfix
```

During the installation, you will be prompted to choose the type of mail configuration; you can select "Internet Site" if your server should send emails directly to the Internet or choose another option that better fits your setup.

If you specifically need `sendmail`, you can install it with:

```sh
sudo apt update
sudo apt install sendmail
```

After installing, you may need to configure it to suit your requirements.

Verifying your Fail2Ban installation and setup involves several steps to ensure it's installed, running correctly, and effectively banning IPs that meet your defined criteria for banning. Here’s how you can go about it:

### 1. Check Fail2Ban Installation

First, check if Fail2Ban is installed by querying its version. This command helps confirm the installation and shows the installed version:

```sh
fail2ban-client version
```

### 2. Verify Fail2Ban Service Status

Next, verify that the Fail2Ban service is active and running on your system:

```sh
sudo systemctl status fail2ban
```

This command gives you the status of Fail2Ban, showing whether it's active (running) or not. An active status indicates that Fail2Ban is running as expected.

### 3. Check Fail2Ban Configuration

Fail2Ban works based on jail configurations that define which services to monitor and the criteria for banning IPs. You can check your active jails using:

```sh
sudo fail2ban-client status
```

This command lists all jails that are currently enabled. To dive deeper into the configuration of a specific jail, use:

```sh
sudo fail2ban-client status <jail-name>
```

Replace `<jail-name>` with the name of the jail you want to inspect. This will show you details like the currently banned IPs for that jail.

### 4. Test Fail2Ban Filtering

To ensure Fail2Ban is correctly identifying and banning offending IPs, you can simulate an attack or a failed login attempt (depending on what your jails are monitoring) and then check if Fail2Ban bans the IP as expected. For example, if you have a jail set up for SSH, you could attempt to log in with incorrect credentials multiple times from a specific IP.

Afterwards, use the command to check the status of the sshd jail (if that’s what you’re testing):

```sh
sudo fail2ban-client status sshd
```

This should show the offending IP as banned.

### 5. Review Fail2Ban Logs

Fail2Ban logs actions (such as banning and unbanning IPs) to its log file, which is typically located at `/var/log/fail2ban.log`. You can inspect this file to see the history of Fail2Ban’s actions:

```sh
sudo less /var/log/fail2ban.log
```

This allows you to scroll through the log file. Look for entries related to the jails you're interested in to verify that Fail2Ban is actively monitoring and taking action.

### 6. Check Firewall Rules

Fail2Ban bans IPs by updating firewall rules to reject traffic from those IPs. You can check the current firewall rules to see the bans in effect:

For `iptables`, use:

```sh
sudo iptables -L
```

For `nftables`, use:

```sh
sudo nft list ruleset
```

### Conclusion

By following these steps, you can thoroughly verify your Fail2Ban installation and setup. It’s important to periodically check Fail2Ban’s status and logs to ensure it continues to protect your system effectively against unwanted access attempts.

When using Packer to provision machines with Ansible, including setting up Fail2Ban as part of the provisioning process, the location of the Fail2Ban configuration file (e.g., `jail.local`) on your **control machine** (the machine running Packer) can be anywhere that is accessible to the Ansible playbook being executed by Packer. However, during the playbook run, you'll need to ensure that this file gets copied to the correct location on the **target machine** (the machine being provisioned by Packer).

The standard location for the Fail2Ban configuration file `jail.local` on the target machine is `/etc/fail2ban/jail.local`. This is where Fail2Ban expects to find override settings for its default configuration.

Here's a high-level overview of how this process might look:

1. **On your control machine**: Place your `jail.local` file in a known location within your project's directory structure where Packer and Ansible have access to it. For example, if you have a directory structure like this:

    ```
    my-packer-project/
    ├── ansible/
    │   ├── playbook.yml
    │   └── roles/
    │       └── fail2ban/
    │           ├── files/
    │           │   └── jail.local  # Your custom Fail2Ban config
    │           └── tasks/
    │               └── main.yml
    └── packer.json
    ```

    You might place `jail.local` under `ansible/roles/fail2ban/files/`.

2. **In your Ansible playbook**: Add a task to copy the `jail.local` file from its location in your project directory to the correct location on the target machine. If using roles, this might be defined in a task like:

    ```yaml
    - name: Copy Fail2Ban configuration file
      ansible.builtin.copy:
        src: jail.local
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
    ```

    This assumes that your playbook or role has appropriate tasks for installing and configuring Fail2Ban, and that the `copy` task is part of a role or playbook that runs after Fail2Ban is installed.

3. **In your Packer configuration**: Ensure that Packer is set to use Ansible as a provisioner, and point it to your playbook. For example, in `packer.json`, you might have something like:

    ```json
    {
      "provisioners": [
        {
          "type": "ansible",
          "playbook_file": "ansible/playbook.yml"
        }
      ]
    }
    ```

4. **Running Packer**: When you run Packer, it will use Ansible to execute your playbook on the target machine as part of the provisioning process. The `copy` task in your playbook will transfer the `jail.local` file from your control machine to the correct location on the target machine.

Remember, the key is that the `jail.local` file needs to be accessible to the Ansible playbook when it runs, and the playbook should take care of placing it in the correct location on the target machine.

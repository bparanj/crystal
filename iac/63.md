To install Ruby 3.3.0 from source using an Ansible playbook that can be run by Packer, you'll need to perform several steps: downloading the Ruby source code, extracting it, configuring, compiling, and finally installing it. This playbook demonstrates how to achieve that.

### Playbook: install_ruby_from_source.yml

```yaml
---
- name: Install Ruby 3.3.0 from source
  hosts: all
  become: true
  vars:
    ruby_version: "3.3.0"
    ruby_download_url: "https://cache.ruby-lang.org/pub/ruby/3.3/ruby-{{ ruby_version }}.tar.gz"
    ruby_source_dir: "/usr/local/src/ruby-{{ ruby_version }}"
    ruby_prefix_dir: "/usr/local"

  tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name:
          - build-essential
          - libssl-dev
          - libreadline-dev
          - zlib1g-dev
        state: present
        update_cache: yes

    - name: Download Ruby source code
      ansible.builtin.get_url:
        url: "{{ ruby_download_url }}"
        dest: "/tmp/ruby-{{ ruby_version }}.tar.gz"
        mode: '0644'

    - name: Extract Ruby source code
      ansible.builtin.unarchive:
        src: "/tmp/ruby-{{ ruby_version }}.tar.gz"
        dest: "/usr/local/src"
        remote_src: yes
        creates: "{{ ruby_source_dir }}"

    - name: Configure Ruby source
      ansible.builtin.shell:
        cmd: "./configure --prefix={{ ruby_prefix_dir }} --disable-install-doc"
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_source_dir }}/Makefile"

    - name: Compile Ruby source
      ansible.builtin.shell:
        cmd: make -j"$(nproc)"
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_source_dir }}/ruby"

    - name: Install Ruby
      ansible.builtin.shell:
        cmd: make install
        chdir: "{{ ruby_source_dir }}"
        creates: "{{ ruby_prefix_dir }}/bin/ruby"
```

### Explanation of Tasks:

1. **Install Required Packages**: Installs dependencies needed to compile Ruby from source.
2. **Download Ruby Source Code**: Fetches the Ruby tarball from the official repository.
3. **Extract Ruby Source Code**: Extracts the tarball to a source directory.
4. **Configure Ruby Source**: Runs the `./configure` script to prepare Ruby for compilation with specified options.
5. **Compile Ruby Source**: Compiles Ruby using `make` leveraging multiple cores for faster compilation with `nproc`.
6. **Install Ruby**: Installs Ruby to the specified prefix directory.

### How to Run This Playbook with Packer:

To run this playbook as part of a Packer build, you would typically define a provisioner in your Packer template JSON or HCL file. Here's an example in JSON syntax:

```json
{
  "type": "ansible-local",
  "playbook_file": "path/to/install_ruby_from_source.yml"
}
```

Ensure you adjust `"path/to/install_ruby_from_source.yml"` to the actual path where your playbook is located.

### Note:

- The playbook assumes you are running it on a Debian or Ubuntu system, as it uses the `apt` module for installing packages. If you're targeting a different system, you may need to adjust the package installation task accordingly.
- After installation, you can verify Ruby installation by running `ruby -v` to see if Ruby 3.3.0 is correctly installed. This command might not be available until you log out and log back in or source your profile again, depending on your environment.
